name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Update manifest version
        run: |
          sed -i 's/"version": ".*"/"version": "${{ steps.version.outputs.VERSION }}"/' \
            custom_components/nordpool_dayahead/manifest.json
          echo "manifest.json updated to version ${{ steps.version.outputs.VERSION }}"

      - name: Commit updated manifest (back to tag)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add custom_components/nordpool_dayahead/manifest.json
          git diff --staged --quiet || git commit -m "chore: bump manifest to ${{ steps.version.outputs.VERSION }}"
          git push origin HEAD:main || true

      - name: Create release zip
        run: |
          zip -r nordpool_dayahead.zip custom_components/

      - name: Extract release notes from CHANGELOG
        id: notes
        shell: bash
        run: |
          python - <<'PY'
          import os
          import re
          from pathlib import Path

          tag = os.environ["GITHUB_REF_NAME"]
          changelog = Path("CHANGELOG.md").read_text(encoding="utf-8").splitlines()

          header_re = re.compile(rf"^## \[{re.escape(tag)}\](?:\s+-\s+\d{{4}}-\d{{2}}-\d{{2}})?\s*$")
          section_start = None

          for index, line in enumerate(changelog):
              if header_re.match(line):
                  section_start = index
                  break

          if section_start is None:
              raise SystemExit(f"No CHANGELOG section found for tag {tag}")

          section_end = len(changelog)
          for index in range(section_start + 1, len(changelog)):
              if changelog[index].startswith("## ["):
                  section_end = index
                  break

          body = "\n".join(changelog[section_start:section_end]).strip()
          if not body:
              raise SystemExit(f"CHANGELOG section for {tag} is empty")

          output_path = Path(os.environ["GITHUB_OUTPUT"])
          with output_path.open("a", encoding="utf-8") as handle:
              handle.write("body<<EOF\n")
              handle.write(body)
              handle.write("\nEOF\n")

          print(f"Release notes extracted for {tag}")
          PY

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Nordpool Day-Ahead ${{ github.ref_name }}"
          body: ${{ steps.notes.outputs.body }}
          files: nordpool_dayahead.zip
          draft: false
          prerelease: false
